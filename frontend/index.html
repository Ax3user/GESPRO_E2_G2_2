<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestor de tareas</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 30px; }
    h1 { margin-bottom: 10px; }

    .form { background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
    input, select, button { padding: 6px; margin-right: 5px; }
    button { cursor: pointer; }
    #msg { margin-left: 10px; font-weight: bold; }

    .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
    .col { background: white; padding: 10px; border-radius: 6px; min-height: 280px; }
    .col h3 { text-align: center; margin-top: 5px; }

    .lane { padding: 8px; border-radius: 6px; min-height: 220px; }

    .task {
      background: #eee;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: grab;
      user-select: none;
      border: 1px solid rgba(0,0,0,0.08);
    }
    .task:active { cursor: grabbing; }

    .todo { background: #e0e7ff; }
    .progress { background: #fff4cc; }
    .done { background: #d1fadf; }

    /* Visual cuando estás “encima” con algo arrastrándose */
    .drop-hover { outline: 2px dashed #333; outline-offset: 4px; }

    .hint { color: #666; font-size: 12px; text-align: center; margin-top: 6px; }
  </style>
</head>
<body>

<h1>Gestor de tareas</h1>

<div class="form">
  <input id="title" placeholder="Título de la tarea">
  <select id="status">
    <option value="TODO">TODO</option>
    <option value="IN_PROGRESS">IN_PROGRESS</option>
    <option value="DONE">DONE</option>
  </select>
  <button onclick="createTask()">Crear</button>
  <button onclick="checkHealth()">Probar /health</button>
  <span id="msg"></span>
</div>

<p id="healthStatus" style="margin-top:10px; font-weight:bold;"></p>


<div class="board">
  <div class="col">
    <h3>TODO</h3>
    <div class="lane" id="todoLane" data-status="TODO"></div>
    <div class="hint">Arrastra tareas aquí</div>
  </div>

  <div class="col">
    <h3>IN_PROGRESS</h3>
    <div class="lane" id="progressLane" data-status="IN_PROGRESS"></div>
    <div class="hint">Arrastra tareas aquí</div>
  </div>

  <div class="col">
    <h3>DONE</h3>
    <div class="lane" id="doneLane" data-status="DONE"></div>
    <div class="hint">Arrastra tareas aquí</div>
  </div>
</div>

<script>
const API = "http://127.0.0.1:5000";

const msg = document.getElementById("msg");
const todoLane = document.getElementById("todoLane");
const progressLane = document.getElementById("progressLane");
const doneLane = document.getElementById("doneLane");

let draggedTaskId = null;

function setMsg(text, ok=true){
  msg.textContent = text || "";
  msg.style.color = ok ? "green" : "crimson";
}

function makeTaskDiv(t){
  const div = document.createElement("div");
  div.className = "task";
  div.textContent = `#${t.id} ${t.title}`;
  div.setAttribute("draggable", "true");
  div.dataset.id = t.id;

  // Drag start
  div.addEventListener("dragstart", (e) => {
    draggedTaskId = Number(div.dataset.id);
    e.dataTransfer.effectAllowed = "move";
    e.dataTransfer.setData("text/plain", String(draggedTaskId));
  });

  // Drag end
  div.addEventListener("dragend", () => {
    draggedTaskId = null;
  });

  return div;
}

async function loadTasks() {
  const res = await fetch(API + "/tasks");
  const tasks = await res.json();

  todoLane.innerHTML = "";
  progressLane.innerHTML = "";
  doneLane.innerHTML = "";

  tasks.forEach(t => {
    const div = makeTaskDiv(t);

    if (t.status === "TODO") {
      div.classList.add("todo");
      todoLane.appendChild(div);
    } else if (t.status === "IN_PROGRESS") {
      div.classList.add("progress");
      progressLane.appendChild(div);
    } else if (t.status === "DONE") {
      div.classList.add("done");
      doneLane.appendChild(div);
    }
  });
}

async function createTask() {
  setMsg("");

  const title = document.getElementById("title").value.trim();
  const status = document.getElementById("status").value;

  const res = await fetch(API + "/tasks", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({title, status})
  });

  const data = await res.json();
  if (!res.ok) {
    setMsg(data.error || "Error", false);
    return;
  }

  document.getElementById("title").value = "";
  setMsg(`Creada: #${data.id}`, true);
  loadTasks();
}

// ✅ Actualizar estado en backend (drag & drop)
async function moveTask(taskId, newStatus){
  const res = await fetch(`${API}/tasks/${taskId}`, {
    method: "PATCH",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ status: newStatus })
  });
  const data = await res.json();
  if (!res.ok){
    setMsg(data.error || "No se pudo mover la tarea", false);
    return;
  }
  setMsg(`Movida: #${data.id} → ${data.status}`, true);
  loadTasks();
}

async function checkHealth() {
  const el = document.getElementById("healthStatus");
  el.textContent = "Consultando /health...";

  try {
    const res = await fetch(API + "/health");
    const data = await res.json();
    el.textContent = `Backend: ${data.status} – ${data.message} (tareas: ${data.tasks_count})`;
    el.style.color = "green";
  } catch (e) {
    el.textContent = "No se pudo conectar con el backend";
    el.style.color = "crimson";
  }
}

// ✅ Hacer que las columnas acepten drop
function enableDrop(lane){
  lane.addEventListener("dragover", (e) => {
    e.preventDefault(); // necesario para permitir drop
    lane.classList.add("drop-hover");
    e.dataTransfer.dropEffect = "move";
  });

  lane.addEventListener("dragleave", () => {
    lane.classList.remove("drop-hover");
  });

  lane.addEventListener("drop", (e) => {
    e.preventDefault();
    lane.classList.remove("drop-hover");

    // Recupera id arrastrado
    const idFromTransfer = Number(e.dataTransfer.getData("text/plain"));
    const taskId = draggedTaskId ?? idFromTransfer;
    const newStatus = lane.dataset.status;

    if (!taskId || !newStatus) return;
    moveTask(taskId, newStatus);
  });
}

enableDrop(todoLane);
enableDrop(progressLane);
enableDrop(doneLane);

// Inicial
loadTasks();
</script>


</body>
</html>
